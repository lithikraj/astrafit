<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AstraFit - Premium Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&family=Space+Grotesk:wght@300;400;600&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/sw.js');
        }

        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['"Outfit"', 'sans-serif'],
                        'mono': ['"Space Grotesk"', 'monospace'],
                    },
                    colors: {
                        primary: '#8b5cf6', // Violet 500
                        secondary: '#d946ef', // Fuchsia 500
                        dark: '#030014', // Deep Purple Black
                        surface: '#0f0720', // Dark Purple Surface
                        glass: 'rgba(255, 255, 255, 0.05)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #030014;
            background-image:
                radial-gradient(circle at 15% 50%, rgba(139, 92, 246, 0.15), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(217, 70, 239, 0.15), transparent 25%);
            background-attachment: fixed;
            -webkit-tap-highlight-color: transparent;
        }

        /* Smooth View Transitions */
        .view-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            min-height: 100vh;
            padding-bottom: 300px;
            /* Increased to clear Nav + Floating Buttons */
        }

        .view-section.active {
            display: block;
            opacity: 1;
        }

        /* Glass Cards */
        .glass-card {
            background: rgba(15, 7, 32, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(139, 92, 246, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* Premium Inputs */
        .input-premium {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: all 0.3s ease;
        }

        .input-premium:focus {
            background: rgba(139, 92, 246, 0.05);
            border-color: #8b5cf6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.1);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #3b0764;
            border-radius: 2px;
        }

        /* Global Reset & Scroll Force */
        html,
        body {
            height: 100%;
            overflow-x: hidden;
            overflow-y: scroll !important;
            /* Force scrollbar */
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>

<body class="text-gray-200 antialiased font-sans overflow-x-hidden selection:bg-primary selection:text-white">

    <!-- ================= NAVBAR ================= -->

    <nav
        class="fixed bottom-0 left-0 right-0 z-50 bg-[#0a0518]/90 backdrop-blur-xl border-t border-white/5 pb-safe pt-2 px-6 shadow-2xl h-[88px]">
        <div class="relative flex justify-between items-center max-w-md mx-auto h-full pb-4">

            <!-- Left Group -->
            <div class="flex gap-8">
                <button onclick="navigateTo('home')"
                    class="nav-item flex flex-col items-center gap-1 text-gray-400 hover:text-primary transition group w-12">
                    <i class="fa-solid fa-layer-group text-xl group-hover:scale-110 transition-transform"></i>
                    <span class="text-[9px] uppercase tracking-wider font-semibold">Home</span>
                </button>
                <button onclick="navigateTo('notes')"
                    class="nav-item flex flex-col items-center gap-1 text-gray-400 hover:text-primary transition group w-12">
                    <i class="fa-solid fa-wand-magic-sparkles text-xl group-hover:scale-110 transition-transform"></i>
                    <span class="text-[9px] uppercase tracking-wider font-semibold">AI Note</span>
                </button>
            </div>

            <!-- Center FAB (Absolute) -->
            <button onclick="navigateTo('log')" class="absolute left-1/2 -top-6 -translate-x-1/2 group">
                <div
                    class="bg-gradient-to-tr from-primary to-secondary h-14 w-14 rounded-full flex items-center justify-center shadow-lg shadow-purple-500/30 group-hover:shadow-purple-500/50 group-hover:scale-105 transition-all border-4 border-[#030014]">
                    <i class="fa-solid fa-plus text-white text-2xl"></i>
                </div>
                <span
                    class="block text-center text-[9px] uppercase tracking-wider font-semibold mt-1 text-white/90">Log</span>
            </button>

            <!-- Right Group -->
            <div class="flex gap-8">
                <button onclick="navigateTo('stats')"
                    class="nav-item flex flex-col items-center gap-1 text-gray-400 hover:text-primary transition group w-12">
                    <i class="fa-solid fa-chart-pie text-xl group-hover:scale-110 transition-transform"></i>
                    <span class="text-[9px] uppercase tracking-wider font-semibold">Stats</span>
                </button>
                <button onclick="alert('Settings coming soon!')"
                    class="nav-item flex flex-col items-center gap-1 text-gray-400 hover:text-primary transition group w-12">
                    <i class="fa-solid fa-gear text-xl group-hover:scale-110 transition-transform"></i>
                    <span class="text-[9px] uppercase tracking-wider font-semibold">H</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- ================= DASHBOARD (List) ================= -->
    <section id="home-view" class="view-section active p-6">
        <header class="flex justify-between items-center mb-8 pt-4">
            <div>
                <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-gray-400 bg-clip-text text-transparent">
                    AstraFit</h1>
                <p class="text-sm text-gray-500">Premium Workout Tracker</p>
            </div>
            <div class="flex gap-3">
                <button id="pwa-install-btn" style="display: none;" onclick="installPWA()"
                    class="h-10 px-4 rounded-full bg-white/10 hover:bg-white/20 text-xs font-bold uppercase tracking-widest text-white transition flex items-center gap-2">
                    <i class="fa-solid fa-download"></i> Install App
                </button>
                <div
                    class="h-10 w-10 rounded-full bg-gradient-to-br from-primary to-secondary flex items-center justify-center text-white font-bold shadow-lg">
                    AF
                </div>
            </div>
        </header>

        <!-- Stats Overview Cards -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="glass-card p-4 rounded-2xl relative overflow-hidden group">
                <div
                    class="absolute -right-4 -top-4 w-16 h-16 bg-primary/20 rounded-full blur-xl group-hover:bg-primary/30 transition">
                </div>
                <p class="text-xs text-gray-400 uppercase tracking-wider">Total Workouts</p>
                <h3 id="stat-count" class="text-3xl font-bold text-white mt-1">--</h3>
            </div>
            <div class="glass-card p-4 rounded-2xl relative overflow-hidden group">
                <div
                    class="absolute -right-4 -top-4 w-16 h-16 bg-secondary/20 rounded-full blur-xl group-hover:bg-secondary/30 transition">
                </div>
                <p class="text-xs text-gray-400 uppercase tracking-wider">Active Streak</p>
                <h3 class="text-3xl font-bold text-white mt-1">3 <span
                        class="text-sm font-normal text-gray-500">Days</span></h3>
            </div>
        </div>

        <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-white">Recent History</h2>
            <button onclick="fetchWorkouts()" class="text-primary text-sm hover:text-white transition"><i
                    class="fa-solid fa-rotate-right mr-1"></i> Refresh</button>
        </div>

        <!-- Search Bar -->
        <div class="mb-5">
            <div class="relative">
                <i class="fa-solid fa-search absolute left-4 top-3.5 text-gray-500 text-sm"></i>
                <input type="text" id="history-search" onkeyup="renderHistory()" placeholder="Search logs & notes..."
                    class="w-full bg-white/5 border border-white/10 rounded-xl py-3 pl-10 pr-4 text-white text-sm outline-none focus:border-primary/50 transition placeholder-gray-600">
            </div>
        </div>

        <div id="workout-list" class="space-y-4">
            <!-- Loading State -->
            <div class="animate-pulse flex space-x-4 p-4 glass-card rounded-2xl">
                <div class="flex-1 space-y-4 py-1">
                    <div class="h-4 bg-white/10 rounded w-3/4"></div>
                    <div class="space-y-2">
                        <div class="h-4 bg-white/10 rounded"></div>
                        <div class="h-4 bg-white/10 rounded w-5/6"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="h-40 w-full"></div> <!-- SPACER -->
    </section>

    <!-- ================= SMART NOTES ================= -->
    <section id="notes-view" class="view-section p-6">
        <header class="mb-6 pt-4">
            <button onclick="navigateTo('home')" class="text-gray-500 hover:text-white mb-2"><i
                    class="fa-solid fa-arrow-left"></i> Back</button>
            <h1 class="text-3xl font-bold text-white">Smart Notes</h1>
            <p class="text-sm text-gray-500">Type freely. We'll handle the rest.</p>
        </header>

        <div class="glass-card rounded-2xl p-4 mb-6">
            <textarea id="note-input" rows="8"
                class="w-full bg-transparent text-white placeholder-gray-600 outline-none resize-none font-mono text-sm leading-relaxed"
                placeholder="Example:
30-12-2025 Shoulders
Press 15kg 12reps
Fly 10kg 15reps..."></textarea>

            <div class="flex justify-end mt-2 pt-2 border-t border-white/5">
                <button onclick="parseAndPreview()"
                    class="text-secondary text-sm font-bold uppercase tracking-widest hover:text-white transition">
                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> Analyze
                </button>
            </div>
        </div>

        <!-- Preview Modal/Area -->
        <div id="note-preview" class="hidden mb-24">
            <h3 class="text-white font-bold mb-3">Preview</h3>
            <div id="preview-content" class="glass-card p-4 rounded-2xl mb-4 border border-primary/30"></div>
            <button onclick="saveNote()"
                class="w-full bg-gradient-to-r from-primary to-secondary p-4 rounded-2xl text-white font-bold text-lg shadow-lg shadow-purple-900/40 hover:scale-[1.02] active:scale-95 transition-transform">
                <i class="fa-solid fa-floppy-disk mr-2"></i> Save to Log
            </button>
        </div>
        <div class="h-40 w-full"></div> <!-- SPACER -->
    </section>

    <!-- ================= LOGGING (Manual) ================= -->
    <section id="log-view" class="view-section p-6">
        <header class="mb-6 pt-4">
            <button onclick="navigateTo('home')" class="text-gray-500 hover:text-white mb-2"><i
                    class="fa-solid fa-arrow-left"></i> Back</button>
            <h1 class="text-3xl font-bold text-white">Manual Log</h1>
        </header>

        <div class="glass-card rounded-2xl p-1 overflow-hidden">
            <div class="p-5 space-y-5">
                <div>
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Session
                        Title</label>
                    <input id="wName" type="text" placeholder="e.g. Upper Body Power"
                        class="input-premium w-full p-4 rounded-xl text-white outline-none placeholder-gray-600 font-medium">
                </div>

                <div>
                    <label class="block text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Date</label>
                    <input id="wDate" type="date"
                        class="input-premium w-full p-4 rounded-xl text-white outline-none font-medium">
                </div>
            </div>

            <div class="bg-white/5 p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-white font-semibold flex items-center gap-2"><i
                            class="fa-solid fa-dumbbell text-secondary"></i> Exercises</h3>
                </div>

                <div id="exercise-fields" class="space-y-4"></div>

                <button onclick="addExerciseField()"
                    class="w-full py-3 mt-4 rounded-xl border border-dashed border-gray-600 text-gray-400 hover:text-white hover:border-primary hover:bg-primary/5 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-plus-circle"></i> Add Movement
                </button>
            </div>
        </div>

        <div class="fixed bottom-24 left-6 right-6 z-40">
            <button onclick="saveWorkout()"
                class="w-full bg-gradient-to-r from-primary to-secondary p-4 rounded-2xl text-white font-bold text-lg shadow-lg shadow-purple-900/40 hover:scale-[1.02] active:scale-95 transition-transform flex justify-center items-center gap-2">
                <i class="fa-solid fa-check"></i> Save Session
            </button>
        </div>
        <div class="h-40 w-full"></div> <!-- SPACER -->
    </section>

    <!-- ================= ASTRALYTICS (Stats) ================= -->
    <section id="stats-view" class="view-section p-6">
        <header class="mb-8 pt-4">
            <h1 class="text-3xl font-bold text-white">Astralytics</h1>
            <p class="text-sm text-gray-500">Visualize your progress across the cosmos.</p>
        </header>

        <!-- Chart Container -->
        <div class="glass-card p-6 rounded-3xl mb-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-semibold text-white">Volume Load</h3>
                <select id="exercise-selector" onchange="updateChart()"
                    class="bg-black/20 text-xs text-primary border border-primary/30 rounded-lg px-2 py-1 outline-none">
                    <option value="total">All Time</option>
                </select>
            </div>
            <div class="h-64">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <!-- BMI Widget -->
        <div class="glass-card p-6 rounded-2xl mb-6 relative overflow-hidden">
            <div class="absolute top-0 right-0 p-3 opacity-10"><i class="fa-solid fa-person text-6xl text-white"></i>
            </div>
            <h3 class="font-semibold text-white mb-4">Body Mass Index</h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input id="bmi-h" type="number" placeholder="Height (cm)"
                    class="input-premium p-3 rounded-lg text-white bg-black/20">
                <input id="bmi-w" type="number" placeholder="Weight (kg)"
                    class="input-premium p-3 rounded-lg text-white bg-black/20">
            </div>
            <div class="flex items-center gap-4">
                <button onclick="calculateBMI()"
                    class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg transition">Calculate</button>
                <div id="bmi-result" class="hidden">
                    <span class="text-2xl font-bold text-secondary" id="bmi-val">22.4</span>
                    <span class="text-xs text-gray-400 ml-1" id="bmi-txt">Healthy</span>
                </div>
            </div>
        </div>

        <!-- 1RM Widget -->
        <div class="glass-card p-6 rounded-2xl relative overflow-hidden">
            <div class="absolute top-0 right-0 p-3 opacity-10"><i
                    class="fa-solid fa-weight-hanging text-6xl text-white"></i></div>
            <h3 class="font-semibold text-white mb-4">One Rep Max</h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input id="rm-w" type="number" placeholder="Lift (kg)"
                    class="input-premium p-3 rounded-lg text-white bg-white/10">
                <input id="rm-r" type="number" placeholder="Reps"
                    class="input-premium p-3 rounded-lg text-white bg-white/10">
            </div>
            <div class="flex items-center gap-4">
                <button onclick="calculate1RM()"
                    class="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg transition">Estimate</button>
                <div id="rm-output" class="hidden">
                    <span class="text-2xl font-bold text-primary" id="rm-val">100</span>
                    <span class="text-xs text-gray-400">KG</span>
                </div>
            </div>
        </div>
        </div>
        <div class="h-40 w-full"></div> <!-- SPACER -->
    </section>

    <script>
        // CONFIG
        const API_URL = '/api/workouts/';
        let allWorkouts = [];
        let mainChart;
        let deferredPrompt;
        let pendingNoteWorkout = null;
        let editingId = null;

        // PWA INSTALLER
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('pwa-install-btn');
            btn.style.display = 'flex';
        });

        async function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('pwa-install-btn').style.display = 'none';
            }
            deferredPrompt = null;
        }

        // NAVIGATION
        function navigateTo(viewId) {
            if (viewId === 'log' && !editingId) {
                document.getElementById('wName').value = '';
                document.getElementById('wDate').value = '';
                document.getElementById('exercise-fields').innerHTML = '';
                addExerciseField();
            }
            if (viewId === 'notes' && !editingId) {
                document.getElementById('note-input').value = '';
                document.getElementById('note-preview').classList.add('hidden');
            }
            if (viewId === 'home') editingId = null;

            document.querySelectorAll('.view-section').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });
            const target = document.getElementById(viewId + '-view');
            target.style.display = 'block';
            setTimeout(() => target.classList.add('active'), 10);
            window.scrollTo(0, 0);
        }

        // DATA FETCHING
        async function fetchWorkouts() {
            const list = document.getElementById('workout-list');
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("API Connection Failed");

                allWorkouts = await res.json();
                document.getElementById('stat-count').innerText = allWorkouts.length;
                renderHistory();
                populateChartSelector();
                updateChart();

            } catch (err) {
                console.error(err);
                if (list) {
                    list.innerHTML = `
                        <div class="p-6 text-center border border-red-500/30 rounded-2xl bg-red-500/5">
                            <i class="fa-solid fa-wifi text-red-400 text-2xl mb-2"></i>
                            <p class="text-red-300">Connection Failed</p>
                            <button onclick="fetchWorkouts()" class="mt-2 text-xs uppercase tracking-widest text-white underline">Retry</button>
                        </div>`;
                }
            }
        }

        function renderHistory() {
            const list = document.getElementById('workout-list');
            const search = document.getElementById('history-search') ? document.getElementById('history-search').value.toLowerCase() : '';

            if (allWorkouts.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-12 opacity-40">
                        <i class="fa-solid fa-wind text-4xl mb-3"></i>
                        <p>No stardata found.</p>
                    </div>`;
                return;
            }

            // Filter & Sort (now includes original_note)
            const filtered = allWorkouts.filter(w =>
                w.name.toLowerCase().includes(search) ||
                w.date.includes(search) ||
                (w.original_note && w.original_note.toLowerCase().includes(search)) ||
                w.exercises.some(ex => ex.name.toLowerCase().includes(search))
            );

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="text-center py-8 opacity-40">
                        <p>No logs match your search.</p>
                    </div>`;
                return;
            }

            const sorted = filtered.slice().reverse();

            list.innerHTML = sorted.map((w, i) => `
                <div onclick="openWorkoutDetails(${w.id})" class="glass-card p-5 rounded-2xl animate-slide-up cursor-pointer hover:bg-white/5 transition" style="animation-delay: ${i * 0.05}s">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg text-white leading-tight">${w.name}</h3>
                            <p class="text-xs text-primary font-mono mt-1">${w.date}</p>
                        </div>
                        <div class="text-gray-600">
                            <i class="fa-solid fa-chevron-right"></i>
                        </div>
                    </div>

                     ${w.original_note ? `<div class="mb-3 text-xs text-gray-400 italic bg-white/5 p-2 rounded">"${w.original_note.substring(0, 60)}${w.original_note.length > 60 ? '...' : ''}"</div>` : ''}

                    <div class="space-y-3">
                        ${w.exercises.slice(0, 3).map(ex => `
                            <div>
                                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">${ex.name}</p>
                                <div class="flex flex-wrap gap-2">
                                    ${ex.sets.map((s, idx) => `
                                        <div class="bg-white/5 border border-white/10 rounded px-2 py-1 text-xs">
                                            <span class="text-white font-mono font-bold">${s.weight}</span><span class="text-gray-600 text-[10px]">kg</span>
                                            <span class="text-white font-mono ml-1">${s.reps}</span><span class="text-gray-600 text-[10px]">reps</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                        ${w.exercises.length > 3 ? `<div class="text-xs text-center text-gray-500">+ ${w.exercises.length - 3} more exercises</div>` : ''}
                    </div>
                </div>
            `).join('');
        }


    </script>

    <!-- ================= DETAIL VIEW ================= -->
    <section id="detail-view" class="view-section p-6">
        <header class="mb-6 pt-4">
            <button onclick="navigateTo('home')" class="text-gray-500 hover:text-white mb-2"><i
                    class="fa-solid fa-arrow-left"></i> Back</button>
            <div class="flex justify-between items-start">
                <div>
                    <h1 id="detail-title" class="text-3xl font-bold text-white leading-tight">...</h1>
                    <p id="detail-date" class="text-sm text-primary font-mono mt-1">...</p>
                </div>
                <button id="detail-delete-btn"
                    class="bg-red-500/10 hover:bg-red-500/20 text-red-500 p-3 rounded-xl transition">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        </header>

        <div id="detail-content" class="space-y-6 mb-24">
            <!-- Dynamic Content -->
        </div>

        </div>
        <div class="h-40 w-full"></div> <!-- SPACER -->
    </section>

    <script>



        // DETAIL VIEW LOGIC
        function openWorkoutDetails(id) {
            const w = allWorkouts.find(x => x.id === id);
            if (!w) return;

            navigateTo('detail');

            document.getElementById('detail-title').innerText = w.name;
            document.getElementById('detail-date').innerText = w.date;

            const content = document.getElementById('detail-content');
            content.innerHTML = '';

            if (w.original_note) {
                content.innerHTML += `
                    <div class="glass-card p-4 rounded-2xl">
                        <p class="text-xs text-gray-400 uppercase tracking-widest mb-2 font-bold">Original Note</p>
                        <p class="text-sm text-gray-300 italic whitespace-pre-wrap">"${w.original_note}"</p>
                    </div>`;
            }

            // Exercises
            w.exercises.forEach(ex => {
                let html = `
                    <div class="glass-card p-5 rounded-2xl">
                         <h3 class="font-bold text-white text-lg mb-3 uppercase tracking-wide">${ex.name}</h3>
                         <div class="space-y-2">`;

                ex.sets.forEach((s, idx) => {
                    html += `
                        <div class="flex justify-between items-center bg-white/5 px-3 py-2 rounded-lg border border-white/5">
                            <div class="flex items-center gap-3">
                                <span class="bg-primary/20 text-primary text-xs font-bold w-6 h-6 rounded flex items-center justify-center">${idx + 1}</span>
                            </div>
                            <div class="flex gap-4">
                                <span class="text-white font-mono font-bold text-lg">${s.weight}<span class="text-xs text-gray-500 font-sans ml-1">kg</span></span>
                                <span class="text-white font-mono font-bold text-lg">${s.reps}<span class="text-xs text-gray-500 font-sans ml-1">reps</span></span>
                            </div>
                        </div>`;
                });

                html += `</div></div>`;
                content.innerHTML += html;
            });

            // Bind Actions
            document.getElementById('detail-edit-btn').onclick = () => loadWorkoutForEdit(id);
            document.getElementById('detail-delete-btn').onclick = () => {
                deleteWorkout(id);
                navigateTo('home');
            };
        }

        // EDIT & EXERCISE LOGIC
        function loadWorkoutForEdit(id) {
            const w = allWorkouts.find(x => x.id === id);
            if (!w) return;

            editingId = id;

            if (w.original_note) {
                // Smart Note Edit
                navigateTo('notes');
                document.getElementById('note-input').value = w.original_note;
                // Auto Preview
                setTimeout(parseAndPreview, 100);
            } else {
                // Manual Log Edit
                navigateTo('log');
                document.getElementById('wName').value = w.name;
                document.getElementById('wDate').value = w.date;

                const container = document.getElementById('exercise-fields');
                container.innerHTML = '';

                w.exercises.forEach(ex => {
                    const div = document.createElement('div');
                    div.className = "bg-black/20 border border-white/5 rounded-xl p-4 animate-fade-in";
                    div.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <input type="text" value="${ex.name}" class="ex-name bg-transparent text-white font-bold placeholder-gray-600 outline-none w-full">
                            <button onclick="this.closest('div.bg-black\\\\/20').remove()" class="text-gray-600 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <div class="sets-container space-y-2 mb-2"></div>
                        <button onclick="addSet(this)" class="text-xs text-primary hover:text-white transition">+ Add Set</button>
                    `;
                    container.appendChild(div);
                    const setsContainer = div.querySelector('.sets-container');
                    ex.sets.forEach((s, i) => {
                        const setRow = document.createElement('div');
                        setRow.className = "flex gap-2 items-center";
                        setRow.innerHTML = `
                            <div class="w-8 text-xs text-gray-600 text-center set-idx">${i + 1}</div>
                            <input type="number" value="${s.weight}" class="s-weight w-full bg-white/5 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-primary/50 transition">
                            <input type="number" value="${s.reps}" class="s-reps w-full bg-white/5 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-primary/50 transition">
                        `;
                        setsContainer.appendChild(setRow);
                    });
                });
            }
        }

        // SMART NOTES PARSER
        function parseAndPreview() {
            const text = document.getElementById('note-input').value;
            if (!text.trim()) return alert("Please type some notes first!");

            const lines = text.split('\n').map(l => l.trim()).filter(l => l);
            const workout = {
                name: "Smart Note Workout",
                date: new Date().toISOString().split('T')[0],
                exercises: [],
                original_note: text
            };

            let currentExercise = null;

            // Heuristics
            const dateRegex = /(\d{1,2})[-/](\d{1,2})[-/](\d{4})/;

            lines.forEach(line => {
                const dateMatch = line.match(dateRegex);
                if (dateMatch) {
                    workout.date = `${dateMatch[3]}-${dateMatch[2]}-${dateMatch[1]}`;
                    const cleanLine = line.replace(dateRegex, '').trim();
                    if (cleanLine) workout.name = cleanLine;
                    return;
                }

                const isSet = /(\d+)\s*(set|kg|reps|lb)/i.test(line) || /^\d+\s*$/.test(line);

                if (isSet) {
                    if (!currentExercise) {
                        currentExercise = { name: "General Movement", sets: [] };
                        workout.exercises.push(currentExercise);
                    }

                    const weightMatch = line.match(/(\d+(?:\.\d+)?)\s*(kg|lbs)/i);
                    const repsMatch = line.match(/(\d+)\s*(reps|rep)/i);

                    let weight = weightMatch ? parseFloat(weightMatch[1]) : 0;
                    let reps = repsMatch ? parseInt(repsMatch[1]) : 0;

                    if (weight === 0 && line.includes('kg')) {
                        const m = line.match(/(\d+(?:\.\d+)?)\s*kg/);
                        if (m) weight = parseFloat(m[1]);
                    }
                    if (reps === 0) {
                        const m = line.match(/(\d+)\s*$/);
                        if (m) reps = parseInt(m[1]);
                    }

                    currentExercise.sets.push({
                        set_number: currentExercise.sets.length + 1,
                        weight: weight,
                        reps: reps || 8
                    });

                } else {
                    currentExercise = { name: line, sets: [] };
                    workout.exercises.push(currentExercise);
                }
            });

            workout.exercises = workout.exercises.filter(e => e.sets.length > 0);

            if (workout.exercises.length === 0) {
                alert("Couldn't detect any sets. Try format: 'Bench Press 50kg 10reps'");
                return;
            }

            pendingNoteWorkout = workout;
            showPreview(workout);
        }

        function showPreview(w) {
            const div = document.getElementById('preview-content');
            div.innerHTML = `
                <div class="mb-2 border-b border-white/10 pb-2">
                    <p class="text-lg font-bold text-white">${w.name}</p>
                    <p class="text-sm text-gray-400">${w.date}</p>
                </div>
                <div class="space-y-2">
                    ${w.exercises.map(e => `
                        <div>
                            <span class="text-secondary font-bold text-xs uppercase">${e.name}</span>
                            <div class="flex flex-wrap gap-1 mt-1">
                                ${e.sets.map(s => `<span class="bg-white/10 px-1 rounded text-xs text-gray-300">${s.weight}kg x ${s.reps}</span>`).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('note-preview').classList.remove('hidden');
        }

        async function saveNote() {
            if (!pendingNoteWorkout) return;
            const btn = document.querySelector('button[onclick="saveNote()"]');
            btn.innerHTML = 'Saving...';

            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `${API_URL}${editingId}/` : API_URL;

            try {
                await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pendingNoteWorkout)
                });

                alert("Saved!");
                document.getElementById('note-input').value = '';
                document.getElementById('note-preview').classList.add('hidden');
                editingId = null;
                navigateTo('home');
                fetchWorkouts();
            } catch (e) {
                alert("Error saving note");
            }
            btn.innerHTML = '<i class="fa-solid fa-floppy-disk mr-2"></i> Save to Log';
        }


        // WORKOUT LOGIC (Manual)
        function addExerciseField() {
            const container = document.getElementById('exercise-fields');
            const id = Date.now();
            const div = document.createElement('div');
            div.className = "bg-black/20 border border-white/5 rounded-xl p-4 animate-fade-in";
            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <input type="text" placeholder="Exercise Name" class="ex-name bg-transparent text-white font-bold placeholder-gray-600 outline-none w-full">
                    <button onclick="this.closest('div.bg-black\\/20').remove()" class="text-gray-600 hover:text-red-400"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="sets-container space-y-2 mb-2"></div>
                <button onclick="addSet(this)" class="text-xs text-primary hover:text-white transition">+ Add Set</button>
            `;
            container.appendChild(div);
            addSet(div.querySelector('button'));
        }

        function addSet(btn) {
            const container = btn.previousElementSibling;
            const div = document.createElement('div');
            div.className = "flex gap-2 items-center";
            div.innerHTML = `
                <div class="w-8 text-xs text-gray-600 text-center set-idx">#</div>
                <input type="number" placeholder="kg" class="s-weight w-full bg-white/5 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-primary/50 transition">
                <input type="number" placeholder="reps" class="s-reps w-full bg-white/5 border border-white/10 rounded p-2 text-white text-sm outline-none focus:border-primary/50 transition">
            `;
            container.appendChild(div);
            updateSetNumbers(container);
        }

        function updateSetNumbers(container) {
            container.querySelectorAll('.set-idx').forEach((el, i) => el.innerText = i + 1);
        }

        async function saveWorkout() {
            const btn = document.querySelector('button[onclick="saveWorkout()"]');
            const originalHTML = btn.innerHTML;
            const exercises = [];
            document.querySelectorAll('#exercise-fields > div').forEach(block => {
                const sets = [];
                block.querySelectorAll('.sets-container > div').forEach((row, i) => {
                    sets.push({
                        set_number: i + 1,
                        weight: row.querySelector('.s-weight').value || 0,
                        reps: row.querySelector('.s-reps').value || 0
                    });
                });
                exercises.push({
                    name: block.querySelector('.ex-name').value || "Unknown Lift",
                    sets: sets
                });
            });

            const payload = {
                name: document.getElementById('wName').value || "Workout",
                date: document.getElementById('wDate').value || new Date().toISOString().split('T')[0],
                exercises: exercises
            };

            const method = editingId ? 'PUT' : 'POST';
            const url = editingId ? `${API_URL}${editingId}/` : API_URL;

            try {
                btn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Saving...';
                await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                document.getElementById('wName').value = '';
                document.getElementById('exercise-fields').innerHTML = '';
                addExerciseField();
                editingId = null;
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Done!';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    navigateTo('home');
                    fetchWorkouts();
                }, 800);
            } catch (e) {
                console.error(e);
                alert("Failed to save.");
                btn.innerHTML = originalHTML;
            }
        }

        async function deleteWorkout(id) {
            if (!confirm("Delete this log?")) return;
            await fetch(`${API_URL}${id}/`, { method: 'DELETE' });
            fetchWorkouts();
        }

        // CHARTS & TOOLS
        function populateChartSelector() {
            const sel = document.getElementById('exercise-selector');
            sel.innerHTML = '<option value="total">Total Volume</option>';
            const metrics = new Set();
            allWorkouts.forEach(w => w.exercises.forEach(e => metrics.add(e.name)));
            metrics.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m;
                sel.appendChild(opt);
            });
        }

        function updateChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const selection = document.getElementById('exercise-selector').value;

            const dataMap = allWorkouts.slice()
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(w => {
                    let vol = 0;
                    w.exercises.forEach(ex => {
                        if (selection === 'total' || ex.name === selection) {
                            ex.sets.forEach(s => vol += (s.weight * s.reps));
                        }
                    });
                    return { x: w.date.substring(5), y: vol };
                })
                .filter(d => d.y > 0);

            if (mainChart) mainChart.destroy();
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.5)');
            gradient.addColorStop(1, 'rgba(139, 92, 246, 0.0)');

            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dataMap.map(d => d.x),
                    datasets: [{
                        label: 'Volume',
                        data: dataMap.map(d => d.y),
                        borderColor: '#d946ef',
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#d946ef',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: '#6b7280' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#6b7280' }
                        }
                    }
                }
            });
        }

        function calculateBMI() {
            const h = parseFloat(document.getElementById('bmi-h').value) / 100;
            const w = parseFloat(document.getElementById('bmi-w').value);
            if (!h || !w) return;
            const bmi = (w / (h * h)).toFixed(1);
            document.getElementById('bmi-val').innerText = bmi;
            document.getElementById('bmi-result').classList.remove('hidden');
            let txt = "Normal";
            if (bmi < 18.5) txt = "Underweight";
            else if (bmi >= 25) txt = "Overweight";
            document.getElementById('bmi-txt').innerText = txt;
        }

        function calculate1RM() {
            const w = parseFloat(document.getElementById('rm-w').value);
            const r = parseFloat(document.getElementById('rm-r').value);
            if (!w || !r) return;
            const rm = Math.round(w * (1 + r / 30));
            document.getElementById('rm-val').innerText = rm;
            document.getElementById('rm-output').classList.remove('hidden');
        }

        // INIT
        addExerciseField();
        fetchWorkouts();

    </script>
</body>

</html>